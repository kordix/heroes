<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hirołsy</title>

    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div id="app">
        Gracz:{{activeplayer }}<span v-if="activeplayerobject">Mana:{{activeplayerobject.mana}}
            Gold:{{activeplayerobject.gold}}</span>
        <div style="display:flex">


            <div id="board">
                <div class="field" v-for="(elem,index) in gd.fields" @click="handleField(elem)"
                    :class="getDynamicClass2(elem)" :id="'field'+elem.x+''+elem.y" :key="index">
                    <span v-if="elem.life" class="life">{{elem.life}}</span><span v-if="elem.life"
                        class="attack">{{elem.attack}}</span>

                    <span v-if="elem.player == 1"></span>
                    <span v-if="elem.player == 2"></span>

                </div>
                <div style="clear:both"></div>

                <p>Czary:</p>
                <button @click="boltbool = true" alt="zadaje 5 dimejdża">Piorun (5)</button>

                <p v-for="elem in gd.messages">{{elem}}</p>
            </div>

            <div>
                Kup jednostki:

                <select name="" id="" v-model="gd.buycode">
                    <option value="skeleton">Szkielet (koszt 10)</option>
                    <option value="mage">Mag (koszt 15)</option>
                </select>

                <button @click="buy" v-if="gd.buycode">Kup</button>

            </div>

        </div>


        <br>

        <button @click="save">Zapisz</button>
        <button @click="load">Załaduj</button>

        <!-- <button @click="next">Koniec tury</button> -->
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.2.2/axios.min.js"></script>
    <script src="maxprop.js"></script>
    <script src="vue.js"></script>

    <script>

        let socketready = 0;

        var conn = new WebSocket('ws://localhost:8082');
        conn.onopen = function (e) {

            console.log("Connection established!");
            socketready = 1;
        };


        function copyProperties(source, target, excludedProperties) {
            for (const prop in source) {
                if (!excludedProperties.includes(prop)) {
                    target[prop] = source[prop];
                }
            }
        }

        let app = new Vue({
            el: '#app',
            data: {
                gd: {
                    turns:0,
                    buycode: '',
                    placebool: false,
                    messages: [],
                    boltbool: false,
                    players: [
                        { id: 1, mana: 9, gold: 50 },
                        { id: 2, mana: 9, gold: 50 },
                    ],
                    gold: [100, 100],
                    activefieldbool: false,
                    activefield: {},
                    enemytypes: [
                        {
                            type: 'enemy',
                            code: 'skeleton',
                            color: 'red',
                            attack: 2,
                            life: 10,
                            speed: 4,
                            active: false,
                            cost: 10
                        },
                        {
                            type: 'enemy',
                            code: 'mage',
                            color: 'blue',
                            attack: 6,
                            life: 5,
                            speed: 2,
                            active: false,
                            cost: 15

                        }
                    ],
                    fields: []
                }

            },
            mounted() {
                let self = this;
                for (let i = 0; i < 10; i++) {
                    for (let j = 0; j < 10; j++) {
                        this.gd.fields.push({ active: false, x: j, y: i, attacked: false, moved: false, color: '', code: '', life: null, class: '', player: null })
                    }
                }

                // this.placeEnemy(1, 1, 'mage', 1);
                this.placeEnemy(0, 5, 'skeleton', 1);

                this.placeEnemy(9, 5, 'skeleton', 2);
                // this.placeEnemy(9, 6, 'skeleton', 2);


                this.next();

                conn.onmessage = function (e) {
                    console.log('MESSAGE');
                    self.load();
                };

            },
            computed: {
                activeplayerobject() {
                    let self = this;
                    return this.gd.players.find((el) => el.id == self.activeplayer)

                },
                activeplayer() {
                    if (this.gd.fields.find((el) => el.active)) {
                        return this.gd.fields.find((el) => el.active).player
                    } else {

                    }
                }
            },
            methods: {
                async save() {
                    await axios.post('api/save.php', this.gd);
                },
                async load() {
                    console.log('load');
                    let self = this;
                    await axios.get('api/load.php').then((res) => self.gd = res.data);
                },
                buy() {
                    this.gd.placebool = true;
                },
                async next() {
                    this.gd.messages = [];
                    let self = this.gd;
                    if (this.gd.fields.find((el) => el.active == true)) {
                        this.gd.fields.find((el) => el.active == true).active = false;
                    }
                    let nextobj = maxProp(this.gd.fields.filter((el) => !el.active && !el.moved && el.code), 'speed', false);
                    if (!nextobj) {
                        this.gd.fields.forEach(el => {
                            el.moved = false;
                        });

                        nextobj = maxProp(this.gd.fields.filter((el) => !el.active && !el.moved && el.code), 'speed', false);

                    }

                    if (!nextobj) {
                        return;
                    }

                    let theobject = this.gd.fields.find((el) => el.x == nextobj.x && el.y == nextobj.y).active = true;
                    theobject.active = true;


                    this.setGreens();

                    if (this.activeplayer) {
                        if (this.gd.players.find((el) => el.id == self.activeplayer)) {
                            this.gd.players.find((el) => el.id == self.activeplayer).mana += 1;
                        }
                    }
                    if(this.gd.turns > 0){
                        await axios.post('api/save.php', this.gd);

                        setTimeout(()=>{
                           conn.send('load');
                        },1000);
                    }

                    this.gd.turns = this.gd.turns + 1;

                    

                    // if (socketready) {
                    //     conn.send('load');
                    // }

                },
                setGreens() {
                    let self = this.gd;
                    let activefieldobject = this.gd.fields.find((el) => el.active == true);

                    if (activefieldobject) {
                        for (let i = 0; i < this.gd.fields.length; i++) {
                            let elem = this.gd.fields[i];

                            let roznica = Math.abs(activefieldobject.x - elem.x) + Math.abs(activefieldobject.y - elem.y);
                            if (roznica <= activefieldobject.speed) {
                                elem.green = true;
                            } else {
                                elem.green = false;
                            }

                        }

                    }

                },
                placeEnemy(x, y, enemycode, player) {
                    let objectfield = this.gd.fields.find((el) => el.x == x && el.y == y);
                    objectfield.player = player;
                    let enemyobject = this.gd.enemytypes.find(el => el.code == enemycode);

                    for (let prop in enemyobject) {
                        if (enemyobject.hasOwnProperty(prop)) {
                            objectfield[prop] = enemyobject[prop];
                        }
                    }
                },
                move(x, y, x2, y2) {

                    const objectfieldold = this.gd.fields.find((el) => el.x == x && el.y == y);

                    const objectfieldnew = this.gd.fields.find((el) => el.x == x2 && el.y == y2);

                    if (document.querySelector('#field' + x2 + y2).classList.contains('green')) {
                        if (!objectfieldnew.type) {
                            copyProperties(objectfieldold, objectfieldnew, ['x', 'y']);
                            objectfieldnew.moved = true;

                            this.clearobject(objectfieldold);
                        }


                        if (objectfieldnew.type == 'enemy') {
                            if (objectfieldold.player != objectfieldnew.player) {
                                if (Math.abs(x2 - x) <= 1 && Math.abs(y2 - y) <= 1) {

                                    objectfieldold.moved = true;
                                    objectfieldnew.life -= objectfieldold.attack;
                                    objectfieldold.life -= Math.floor(objectfieldnew.attack);


                                    if (objectfieldnew.life <= 0) {
                                        this.clearobject(objectfieldnew);
                                    }

                                    if (objectfieldold.life <= 0) {
                                        this.clearobject(objectfieldold);
                                    }


                                }
                            }
                        }

                        objectfieldnew.active = false;
                        this.next();
                    }




                },
                clearobject(obj) {
                    obj.color = '';
                    obj.attack = 0;
                    obj.life = 0;
                    obj.code = '';
                    obj.class = '';
                    obj.attacked = null;
                    obj.moved = null;
                    obj.type = null;
                    obj.active = false;
                    obj.speed = false;
                    obj.player = null;


                },
                handleField(elem) {
                    let self = this;
                    let ap = this.gd.players.find((el) => el.id == self.activeplayer);


                    if (this.gd.placebool && this.gd.buycode) {
                        let cost = this.gd.enemytypes.find((el) => el.code == self.gd.buycode).cost;
                        if (ap.gold < cost) {
                            this.gd.messages.push('ZA MAŁO ZŁOTA');

                            this.gd.placebool = false;
                            return
                        }

                        if (this.activeplayer == 2) {
                            if (elem.x == 9) {

                            } else {
                                this.gd.messages.push('KŁADZ JEDNOSTKI W PIERWSZYM RZĘDZIE');
                                return;
                            }
                        }

                        if (this.activeplayer == 1) {
                            if (elem.x === 0) {

                            } else {
                                this.gd.messages.push('KŁADZ JEDNOSTKI W PIERWSZYM RZĘDZIE');
                                return;
                            }
                        }

                        if (!elem.type) {
                            this.placeEnemy(elem.x, elem.y, this.gd.buycode, this.activeplayer);
                            this.gd.placebool = false;
                            ap.gold -= this.gd.enemytypes.find((el) => el.code == self.gd.buycode).cost
                            return;
                        }
                    }

                    if (this.gd.boltbool) {
                        if (ap.mana <= 5) {

                            self.gd.messages.push('za mało many');
                        }
                        if (elem.type && ap.mana >= 5) {
                            ap.mana -= 5;
                            elem.life -= 2;
                            if (elem.life <= 0) {
                                this.gd.clearobject(elem);
                            }
                        }
                        this.gd.boltbool = false;
                        return
                    }


                    if (this.gd.fields.find((el) => el.active)) {
                        this.move(this.gd.fields.find((el) => el.active).x, this.gd.fields.find((el) => el.active).y, elem.x, elem.y);
                    }

                },
                getDynamicClass2(elem) {
                    let self = this;
                    let green = false;
                    let yellow = false;
                    let activefieldobject = this.gd.fields.find((el) => el.active == true);

                    let dupa = 'skeleton';

                    if (activefieldobject) {
                        let roznica = Math.abs(activefieldobject.x - elem.x) + Math.abs(activefieldobject.y - elem.y);
                        if (roznica <= activefieldobject.speed) {
                            green = true;
                        } else {
                            green = false;
                        }
                    }

                    return {
                        'yellow': elem.active,
                        'blue': elem.player === 1,
                        'red': elem.player === 2,
                        // [elem.color]: elem.color,
                        'green': elem.green,
                        'attacked': elem.attacked,
                        'bolticon': this.gd.boltbool,
                        'add': this.gd.placebool && !elem.type,
                        'skeleton': elem.code == 'skeleton',
                        'mage': elem.code == 'mage',

                        rotate: elem.player == 2
                    };
                },


            }
        })
    </script>
</body>

</html>